# AI Melody ‚Äî –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å](#–±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å)
2. [–í—Å–µ –∫–µ–π—Å—ã –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏](#–≤—Å–µ-–∫–µ–π—Å—ã-–º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏)
3. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
4. [–î–µ–π—Å—Ç–≤–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–¥–µ–ø–ª–æ–π)](#–¥–µ–π—Å—Ç–≤–∏—è-–Ω–∞-—Å–µ—Ä–≤–µ—Ä–µ-–¥–µ–ø–ª–æ–π)
5. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
6. [API –∏ Callback-–ø—É—Ç–∏](#api-–∏-callback-–ø—É—Ç–∏)
7. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
8. [–Æ–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∞](#—é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∞)

---

## –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å

### –ü—Ä–∏–Ω—Ü–∏–ø: ¬´–ü–æ–ø—Ä–æ–±—É–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ ‚Üí –∫—É–ø–∏ –µ—Å–ª–∏ –Ω—Ä–∞–≤–∏—Ç—Å—è¬ª

```
–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
‚îÇ
‚îú‚îÄ 2 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (√ó 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ = 4 –ø—Ä–µ–≤—å—é)
‚îÇ   ‚îî‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç: 30-—Å–µ–∫—É–Ω–¥–Ω–æ–µ voice-–ø—Ä–µ–≤—å—é (OGG Opus)
‚îÇ       ‚îú‚îÄ –ù—Ä–∞–≤–∏—Ç—Å—è ‚Üí –ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–∫ (75‚≠ê / 100‚ÇΩ / 1 –∫—Ä–µ–¥–∏—Ç)
‚îÇ       ‚îî‚îÄ –ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è ‚Üí –°–æ–∑–¥–∞—Ç—å –¥—Ä—É–≥—É—é (–µ—Å–ª–∏ –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ)
‚îÇ
‚îú‚îÄ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–æ–Ω—á–∏–ª–∏—Å—å, –µ—Å—Ç—å –∫—Ä–µ–¥–∏—Ç—ã
‚îÇ   ‚îî‚îÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞ 1 –∫—Ä–µ–¥–∏—Ç ‚Üí –ø–æ–ª–Ω—ã–π MP3 —Å—Ä–∞–∑—É (–≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ)
‚îÇ
‚îî‚îÄ –ù–∏—á–µ–≥–æ –Ω–µ—Ç
    ‚îî‚îÄ ¬´–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤¬ª ‚Üí –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å¬ª
```

### –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫?

- **Telegram –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç DRM** ‚Äî —Ñ–∞–π–ª MP3, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —á–µ—Ä–µ–∑ `answer_audio`, –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∏ –ø–µ—Ä–µ—Å–ª–∞—Ç—å
- **Voice-—Å–æ–æ–±—â–µ–Ω–∏–µ** (`answer_voice`) –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–∂–Ω–µ–µ –∏–∑–≤–ª–µ—á—å ‚Äî –Ω–µ—Ç –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
- **30-—Å–µ–∫—É–Ω–¥–Ω–æ–µ –ø—Ä–µ–≤—å—é** –¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å, –Ω–æ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–∫
- **–û–±—Ä–µ–∑–∫–∞ –∏–∑ —Å–µ—Ä–µ–¥–∏–Ω—ã** (‚Öì –¥–ª–∏–Ω—ã) ‚Äî –æ–±—ã—á–Ω–æ –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ –ø—Ä–∏–ø–µ–≤, —Å–∞–º—É—é —Ü–µ–ø–ª—è—é—â—É—é —á–∞—Å—Ç—å

---

## –í—Å–µ –∫–µ–π—Å—ã –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏

### –ö–µ–π—Å 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –ø–µ—Ä–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

```
–£—Å–ª–æ–≤–∏–µ: free_generations_left > 0
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
  1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–°–æ–∑–¥–∞—Ç—å –ø–µ—Å–Ω—é¬ª
  2. –ü—Ä–æ—Ö–æ–¥–∏—Ç –≤–∏–∑–∞—Ä–¥ (—Å—Ç–∏–ª—å, –≥–æ–ª–æ—Å, –æ–ø–∏—Å–∞–Ω–∏–µ/—Ç–µ–∫—Å—Ç)
  3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Suno API (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤)
  4. free_generations_left -= 1
  5. –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–±–ª–æ–∂–∫–∞ + 30-—Å–µ–∫ voice-–ø—Ä–µ–≤—å—é + –∫–Ω–æ–ø–∫–∞ ¬´–ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî 75‚≠ê¬ª
  6. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: preview_track_kb (–∫–Ω–æ–ø–∫–∞ –ø–æ–∫—É–ø–∫–∏ + —Ä–µ–π—Ç–∏–Ω–≥)
  7. –ü–æ—Å–ª–µ –≤—Å–µ—Ö –ø—Ä–µ–≤—å—é: preview_after_generation_kb (—Ç–æ–ª—å–∫–æ ¬´–°–æ–∑–¥–∞—Ç—å –¥—Ä—É–≥—É—é¬ª)

–î–æ—Ö–æ–¥: $0 (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
–†–∞—Å—Ö–æ–¥: ~$0.05 API
```

### –ö–µ–π—Å 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç –ø—Ä–µ–≤—å—é –∑–∞ –∫—Ä–µ–¥–∏—Ç—ã

```
–£—Å–ª–æ–≤–∏–µ: user.credits >= 1, generation.is_unlocked == False
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
  1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî 75‚≠ê¬ª
  2. cb_buy_track –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
     - –í–ª–∞–¥–µ–ª–µ—Ü –ª–∏ –æ–Ω —ç—Ç–æ–≥–æ —Ç—Ä–µ–∫–∞? (gen.user_id == callback.from_user.id)
     - –ù–µ –∫—É–ø–ª–µ–Ω –ª–∏ —É–∂–µ? (gen.is_unlocked == False)
     - –ï—Å—Ç—å –ª–∏ –∫—Ä–µ–¥–∏—Ç—ã? (user.credits >= 1)
  3. credits -= 1
  4. log_balance_transaction: source='unlock'
  5. generation.is_unlocked = True
  6. –°–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π MP3 ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ answer_audio
  7. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: track_kb (–ø–æ–¥–µ–ª–∏—Ç—å—Å—è + —Ä–µ–π—Ç–∏–Ω–≥)
  8. –ï—Å–ª–∏ video_generation_enabled ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–∏–¥–µ–æ

–î–æ—Ö–æ–¥: 1 –∫—Ä–µ–¥–∏—Ç (75‚≠ê ‚âà 100‚ÇΩ)
```

### –ö–µ–π—Å 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç –ø—Ä–µ–≤—å—é —á–µ—Ä–µ–∑ Telegram Stars (–Ω–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤)

```
–£—Å–ª–æ–≤–∏–µ: user.credits == 0, generation.is_unlocked == False
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
  1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî 75‚≠ê¬ª
  2. cb_buy_track –≤–∏–¥–∏—Ç credits == 0
  3. –°–æ–∑–¥–∞—ë—Ç—Å—è Telegram Stars invoice:
     - payload: "unlock:{gen_id}:{idx}"
     - amount: 75 Stars
  4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –≤ Telegram
  5. on_successful_payment (payments.py):
     - –ü–∞—Ä—Å–∏—Ç payload "unlock:123:0"
     - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–ª–∞—Ç—ë–∂ (create_payment, credits=0)
     - generation.is_unlocked = True
     - –°–∫–∞—á–∏–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π MP3
     - –ï—Å–ª–∏ video_generation_enabled ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–∏–¥–µ–æ
  6. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: track_kb (–ø–æ–¥–µ–ª–∏—Ç—å—Å—è + —Ä–µ–π—Ç–∏–Ω–≥)

–î–æ—Ö–æ–¥: 75‚≠ê –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤)
```

### –ö–µ–π—Å 4: –ü–ª–∞—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–∫—Ä–µ–¥–∏—Ç—ã)

```
–£—Å–ª–æ–≤–∏–µ: free_generations_left == 0, credits >= 1
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
  1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–°–æ–∑–¥–∞—Ç—å –ø–µ—Å–Ω—é¬ª
  2. check_credits() ‚Üí True (–µ—Å—Ç—å –∫—Ä–µ–¥–∏—Ç—ã)
  3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Suno API
  4. credits -= 1, log_balance_transaction: source='generation'
  5. generation.is_unlocked = True (—Å—Ä–∞–∑—É)
  6. –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–±–ª–æ–∂–∫–∞ + –ü–û–õ–ù–´–ô MP3 + –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª
  7. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: track_kb (–ø–æ–¥–µ–ª–∏—Ç—å—Å—è + —Ä–µ–π—Ç–∏–Ω–≥)
  8. –ü–æ—Å–ª–µ –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤: after_generation_kb (—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è + —Å–æ–∑–¥–∞—Ç—å –¥—Ä—É–≥—É—é)
  9. –ï—Å–ª–∏ video_generation_enabled ‚Üí –≤–∏–¥–µ–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

–î–æ—Ö–æ–¥: 1 –∫—Ä–µ–¥–∏—Ç
```

### –ö–µ–π—Å 5: –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–µ—â—ë –≤–∞—Ä–∏–∞–Ω—Ç—ã)

```
–£—Å–ª–æ–≤–∏–µ: –¢–æ–ª—å–∫–æ –¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫–Ω–æ–ø–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É free)
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
  1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–ï—â—ë –≤–∞—Ä–∏–∞–Ω—Ç—ã (‚àí1üéµ)¬ª
  2. credits -= 1
  3. –ù–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
  4. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø–æ–ª–Ω—ã–π MP3 (—Ç.–∫. –ø–ª–∞—Ç–Ω–∞—è)
```

### –ö–µ–π—Å 6: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ —É–∂–µ –∫—É–ø–ª–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞

```
–£—Å–ª–æ–≤–∏–µ: generation.is_unlocked == True
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
  1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–∫¬ª –ø–æ–≤—Ç–æ—Ä–Ω–æ
  2. cb_buy_track –≤–∏–¥–∏—Ç is_unlocked == True
  3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´‚úÖ –≠—Ç–æ—Ç —Ç—Ä–µ–∫ —É–∂–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!¬ª
  4. –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π MP3 (–±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è)
```

### –ö–µ–π—Å 7: –ü–æ–ø—ã—Ç–∫–∞ –∫—É–ø–∏—Ç—å —á—É–∂–æ–π —Ç—Ä–µ–∫

```
–£—Å–ª–æ–≤–∏–µ: gen.user_id != callback.from_user.id
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
  1. cb_buy_track ‚Üí ¬´–≠—Ç–æ –Ω–µ –≤–∞—à —Ç—Ä–µ–∫¬ª
  2. –ù–∏—á–µ–≥–æ –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
```

### –ö–µ–π—Å 8: –ù–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤ –∏ –Ω–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π

```
–£—Å–ª–æ–≤–∏–µ: free_generations_left == 0, credits == 0
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
  1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–°–æ–∑–¥–∞—Ç—å –ø–µ—Å–Ω—é¬ª
  2. check_credits() ‚Üí False
  3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç NO_CREDITS —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
```

### –ö–µ–π—Å 9: –ü–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ (Stars)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí ¬´–ë–∞–ª–∞–Ω—Å¬ª ‚Üí ¬´–û–ø–ª–∞—Ç–∞ Telegram Stars¬ª ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç –ø–∞–∫–µ—Ç:
  - 1üéµ ‚Äî ‚≠ê75
  - 3üéµ ‚Äî ‚≠ê210
  - 5üéµ ‚Äî ‚≠ê325
  - 10üéµ ‚Äî ‚≠ê600
  - 50üéµ ‚Äî ‚≠ê2500

payload: "credits_{credits}_{stars}"
–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã: credits += N
```

### –ö–µ–π—Å 10: –ü–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ (–ö–∞—Ä—Ç–∞ / T-Bank)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí ¬´–ë–∞–ª–∞–Ω—Å¬ª ‚Üí ¬´–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π¬ª ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç –ø–∞–∫–µ—Ç:
  - 1üéµ ‚Äî 100‚ÇΩ
  - 3üéµ ‚Äî 280‚ÇΩ
  - 5üéµ ‚Äî 450‚ÇΩ
  - 10üéµ ‚Äî 800‚ÇΩ
  - 50üéµ ‚Äî 3500‚ÇΩ

–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã T-Bank ‚Üí –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã callback ‚Üí credits += N
```

### –ö–µ–π—Å 11: –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ –∫—É–ø–ª–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞

```
–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
  1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—Ç–∏–ª, –Ω–æ MP3 –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å/–æ—Ç–ø—Ä–∞–≤–∏—Ç—å
  2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—Ñ–∞–Ω–¥: credits += 1
  3. log_balance_transaction: source='refund'
  4. –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–û—à–∏–±–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç—Ä–µ–∫–∞. –ö—Ä–µ–¥–∏—Ç –≤–æ–∑–≤—Ä–∞—â—ë–Ω.¬ª
```

### –ö–µ–π—Å 12: Callback-–ø—É—Ç—å (async –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)

```
–ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω callback_base_url:
  1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, callback –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ /callback/suno
  2. handle_suno_callback –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç free vs paid:
     - Free: voice-–ø—Ä–µ–≤—å—é + preview_track_kb
     - Paid: –ø–æ–ª–Ω—ã–π MP3 + track_kb
  3. –í–∏–¥–µ–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è paid
```

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
     ‚îÇ
     ‚ñº
[generation.py: do_generate]
     ‚îÇ
     ‚îú‚îÄ free? ‚îÄ‚îÄ‚ñ∫ Suno API ‚îÄ‚îÄ‚ñ∫ MP3 ‚îÄ‚îÄ‚ñ∫ pydub/ffmpeg ‚îÄ‚îÄ‚ñ∫ 30-—Å–µ–∫ OGG ‚îÄ‚îÄ‚ñ∫ answer_voice
     ‚îÇ                                                                    + preview_track_kb
     ‚îÇ
     ‚îî‚îÄ paid? ‚îÄ‚îÄ‚ñ∫ Suno API ‚îÄ‚îÄ‚ñ∫ MP3 ‚îÄ‚îÄ‚ñ∫ answer_audio (–ø–æ–ª–Ω—ã–π)
                                         + track_kb
```

### –§–∞–π–ª—ã –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

| –§–∞–π–ª | –†–æ–ª—å |
|------|------|
| `app/config.py` | `unlock_price_stars=75`, `unlock_price_rub=100`, –ø–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤ |
| `app/database.py` | `is_unlocked` –∫–æ–ª–æ–Ω–∫–∞, `unlock_generation()`, `is_generation_unlocked()` |
| `app/audio_preview.py` | `create_preview()` ‚Äî MP3 ‚Üí 30-—Å–µ–∫ OGG Opus (pydub + ffmpeg) |
| `app/keyboards.py` | `preview_track_kb()`, `preview_after_generation_kb()`, `track_kb()` |
| `app/texts.py` | `PREVIEW_CAPTION`, `UNLOCK_SUCCESS`, `UNLOCK_NO_CREDITS`, `UNLOCK_ALREADY` |
| `app/handlers/generation.py` | `do_generate` (free/paid –≤–µ—Ç–≤–ª–µ–Ω–∏–µ), `cb_buy_track`, `cb_download` |
| `app/handlers/callback.py` | `_deliver_result_to_user` (free/paid –≤–µ—Ç–≤–ª–µ–Ω–∏–µ –≤ async-–ø—É—Ç–∏) |
| `app/handlers/payments.py` | `on_successful_payment` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ `unlock:{gen_id}:{idx}` payload |

### –ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–≤—å—é (`audio_preview.py`)

```python
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å MP3 –≤ pydub.AudioSegment
2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–∫—É —Å—Ç–∞—Ä—Ç–∞: total_duration / 3 (–±–ª–∏–∂–µ –∫ –ø—Ä–∏–ø–µ–≤—É)
3. –í—ã—Ä–µ–∑–∞—Ç—å 30-—Å–µ–∫—É–Ω–¥–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç
4. –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞—É–¥–∏–æ ‚Äî –≤–∑—è—Ç—å —Å –Ω–∞—á–∞–ª–∞
5. –î–æ–±–∞–≤–∏—Ç—å fade_in(500ms) –∏ fade_out(1000ms)
6. –≠–∫—Å–ø–æ—Ä—Ç –≤ OGG Opus (bitrate=64k)
```

---

## –î–µ–π—Å—Ç–≤–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–¥–µ–ø–ª–æ–π)

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ffmpeg

```bash
# Ubuntu/Debian
sudo apt-get update && sudo apt-get install -y ffmpeg

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
ffmpeg -version
```

> **–ë–µ–∑ ffmpeg pydub –ù–ï –°–ú–û–ñ–ï–¢ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–µ–≤—å—é ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –ø–∞–¥–∞—Ç—å —Å –æ—à–∏–±–∫–æ–π!**

### 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python

```bash
cd /path/to/telegramMusic
source venv/bin/activate
pip install -r requirements.txt
```

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ ‚Äî –≤ `database.py` –µ—Å—Ç—å:

```sql
IF NOT EXISTS (SELECT 1 FROM information_schema.columns
    WHERE table_name='generations' AND column_name='is_unlocked') THEN
    ALTER TABLE generations ADD COLUMN is_unlocked BOOLEAN NOT NULL DEFAULT FALSE;
END IF;
```

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é:
```bash
psql -U ai_melody -d ai_melody -c "ALTER TABLE generations ADD COLUMN IF NOT EXISTS is_unlocked BOOLEAN NOT NULL DEFAULT FALSE;"
```

### 4. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–æ–±–∞–≤–∏—Ç—å –≤ `.env` –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:

```env
# –¶–µ–Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–µ–≤—å—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 75 Stars, 100‚ÇΩ)
UNLOCK_PRICE_STARS=75
UNLOCK_PRICE_RUB=100

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2)
FREE_CREDITS_ON_SIGNUP=2
```

### 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤—Ä—É—á–Ω—É—é)
# –ë–æ—Ç —Å–∞–º –ø—Ä–∏–º–µ–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
```

### 6. –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

- [ ] `ffmpeg -version` —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] `pip list | grep pydub` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0.25.1
- [ ] –ë–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç voice-–ø—Ä–µ–≤—å—é (–Ω–µ MP3!)
- [ ] –ö–Ω–æ–ø–∫–∞ ¬´–ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî 75‚≠ê¬ª –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π MP3
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∫—Ä–µ–¥–∏—Ç–∞–º–∏ –ø–æ–ª—É—á–∞–µ—Ç MP3 —Å—Ä–∞–∑—É
- [ ] –ë–∞–ª–∞–Ω—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤ (Stars)

| –ö—Ä–µ–¥–∏—Ç—ã | Stars | –¶–µ–Ω–∞/–∫—Ä–µ–¥–∏—Ç |
|---------|-------|-------------|
| 1 | 75‚≠ê | 75‚≠ê |
| 3 | 210‚≠ê | 70‚≠ê (—Å–∫–∏–¥–∫–∞ 7%) |
| 5 | 325‚≠ê | 65‚≠ê (—Å–∫–∏–¥–∫–∞ 13%) |
| 10 | 600‚≠ê | 60‚≠ê (—Å–∫–∏–¥–∫–∞ 20%) |
| 50 | 2500‚≠ê | 50‚≠ê (—Å–∫–∏–¥–∫–∞ 33%) |

### –ü–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤ (–†—É–±–ª–∏ / T-Bank)

| –ö—Ä–µ–¥–∏—Ç—ã | –†—É–±–ª–∏ | –¶–µ–Ω–∞/–∫—Ä–µ–¥–∏—Ç |
|---------|-------|-------------|
| 1 | 100‚ÇΩ | 100‚ÇΩ |
| 3 | 280‚ÇΩ | 93‚ÇΩ |
| 5 | 450‚ÇΩ | 90‚ÇΩ |
| 10 | 800‚ÇΩ | 80‚ÇΩ |
| 50 | 3500‚ÇΩ | 70‚ÇΩ |

---

## API –∏ Callback-–ø—É—Ç–∏

### –î–≤–∞ –ø—É—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:

1. **Polling-–ø—É—Ç—å** (`generation.py: do_generate`)
   - –ë–æ—Ç –∂–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `client.wait_for_completion()`
   - –î–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `message.answer_*`

2. **Callback-–ø—É—Ç—å** (`callback.py: handle_suno_callback`)
   - Suno API –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –Ω–∞ `{callback_base_url}/callback/suno`
   - –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ `bot.send_*`

–û–±–∞ –ø—É—Ç–∏ —Ä–µ–∞–ª–∏–∑—É—é—Ç **–æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ª–æ–≥–∏–∫—É** free/paid –≤–µ—Ç–≤–ª–µ–Ω–∏—è.

### Callback payloads

| Callback data | –•–µ–Ω–¥–ª–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------------|---------|----------|
| `buy_track:{gen_id}:{idx}` | `cb_buy_track` | –ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–≤—å—é |
| `download:{gen_id}:{idx}` | `cb_download` | –°–∫–∞—á–∏–≤–∞–Ω–∏–µ (legacy) |
| `regenerate:{gen_id}` | `cb_regenerate` | –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è |
| `rate:{gen_id}:{rating}` | `cb_rate` | –û—Ü–µ–Ω–∫–∞ |
| `buy_credits:{credits}:{stars}` | `cb_buy_credits` | –ü–æ–∫—É–ø–∫–∞ Stars |
| `buy_tbank:{credits}:{rub}` | `cb_buy_tbank` | –ü–æ–∫—É–ø–∫–∞ –∫–∞—Ä—Ç–æ–π |

### Invoice payloads (Telegram Stars)

| Payload | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|------------|----------|
| `credits_{N}_{stars}` | `on_successful_payment` | –ü–æ–∫—É–ø–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ |
| `unlock:{gen_id}:{idx}` | `on_successful_payment` | –ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–≤—å—é –Ω–∞–ø—Ä—è–º—É—é |

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `generations` ‚Äî –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞

```sql
is_unlocked BOOLEAN NOT NULL DEFAULT FALSE
```

- `FALSE` ‚Äî —Ç—Ä–µ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (—Ç–æ–ª—å–∫–æ –ø—Ä–µ–≤—å—é –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ)
- `TRUE` ‚Äî —Ç—Ä–µ–∫ –∫—É–ø–ª–µ–Ω –∏–ª–∏ –æ–ø–ª–∞—á–µ–Ω –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

### –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `database.py`

```python
unlock_generation(gen_id: int) -> bool     # –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∫—É–ø–ª–µ–Ω–Ω—ã–π
is_generation_unlocked(gen_id: int) -> bool # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
```

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–∞ (`balance_transactions`)

| source | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `free_generation` | –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (‚àí1 free_gen) |
| `generation` | –ü–ª–∞—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (‚àí1 –∫—Ä–µ–¥–∏—Ç) |
| `unlock` | –ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–≤—å—é –∑–∞ –∫—Ä–µ–¥–∏—Ç |
| `unlock_stars` | –ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–≤—å—é –∑–∞ Stars |
| `refund` | –í–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ |
| `stars` | –ü–æ–∫—É–ø–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ –∑–∞ Stars |
| `tbank` | –ü–æ–∫—É–ø–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ –∫–∞—Ä—Ç–æ–π |

---

## –Æ–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∞

### –†–∞—Å—á—ë—Ç –Ω–∞ 1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –ü–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é | ~600 (60%) |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | 2 (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ) |
| –í—Å–µ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π | ~1200 |
| –†–∞—Å—Ö–æ–¥ API (√ó4‚ÇΩ) | ~4800‚ÇΩ |
| –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø–æ–∫—É–ø–∫—É | ~15% |
| –ü–æ–∫—É–ø–æ–∫ | ~90 |
| –î–æ—Ö–æ–¥ (90 √ó 100‚ÇΩ √ó 0.7 Telegram) | ~6300‚ÇΩ |
| **–ü—Ä–∏–±—ã–ª—å** | **~1500‚ÇΩ** |

### –†—ã—á–∞–≥–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

| –†—ã—á–∞–≥ | –¢–µ–∫—É—â–µ–µ | –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å |
|-------|---------|-------------|
| –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ | 2 | `FREE_CREDITS_ON_SIGNUP` |
| –¶–µ–Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ | 75‚≠ê | `UNLOCK_PRICE_STARS` |
| –¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö | 100‚ÇΩ | `UNLOCK_PRICE_RUB` |
| –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π | 10 | `MAX_GENERATIONS_PER_USER_PER_DAY` |
| –î–ª–∏–Ω–∞ –ø—Ä–µ–≤—å—é | 30 —Å–µ–∫ | `PREVIEW_DURATION_SEC` –≤ `audio_preview.py` |
